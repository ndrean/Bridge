<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local-First Postgres</title>
    <style>
      body {
        font-family: -apple-system, system-ui, sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }
      pre {
        background: #f4f4f4;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
      }
      .badge {
        background: #e0f2f1;
        color: #00695c;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
      }
    </style>
  </head>
  <body>
    <h1>‚ö° Local-First Postgres</h1>
    <div class="grid">
      <div>
        <h3>Real-time Data (PGLite)</h3>
        <p>Running inside your browser (WASM).</p>
        <div id="status">üî¥ Connecting...</div>
        <pre id="rows">Waiting for data...</pre>
      </div>
      <div>
        <h3>Live Events</h3>
        <div id="logs"></div>
      </div>
    </div>

    <script type="module">
      import { PGlite } from "https://cdn.jsdelivr.net/npm/@electric-sql/pglite/dist/index.js";
      import {
        connect,
        jwtAuthenticator,
      } from "https://cdn.jsdelivr.net/npm/nats.ws@1.30.3/+esm";
      import nkeysJs from "https://cdn.jsdelivr.net/npm/nkeys.js@1.1.0/+esm";
      import { unpack } from "https://cdn.jsdelivr.net/npm/msgpackr@1.11.8/+esm";
      // import { jetstream } from "https://cdn.jsdelivr.net/npm/@nats-io/jetstream@3.3.0/+esm";

      // DOM Elements
      const statusEl = document.getElementById("status");
      const rowsEl = document.getElementById("rows");
      const logsEl = document.getElementById("logs");

      function log(msg) {
        const div = document.createElement("div");
        div.innerHTML = `<span class="badge">${new Date().toLocaleTimeString()}</span> ${msg}`;
        logsEl.prepend(div);
      }

      async function init() {
        try {
          // 1. Start PGLite (In-Memory Postgres)
          log("Starting PGLite WASM...");
          const db = new PGlite();
          // Create table to match our schema
          await db.exec(`
                      CREATE TABLE IF NOT EXISTS users (
                          id TEXT PRIMARY KEY,
                          name TEXT,
                          email TEXT
                      );
                  `);
          log("‚úÖ PGLite Ready");

          // 2. Security: Generate Browser Keys
          const user = nkeysJs.createUser();
          const seed = new TextDecoder().decode(user.getSeed());
          const publicKey = user.getPublicKey();
          console.log({ publicKey });
          log(`üîë Generated Key: ${publicKey.slice(0, 8)}...`);

          // 3. Authenticate with Django
          const authResp = await fetch("/auth/nats", {
            method: "POST",
            body: JSON.stringify({ public_key: publicKey }),
          });
          const { jwt } = await authResp.json();

          // 4. Connect to NATS (WebSocket)
          // Ensure your NATS container exposes port 9222
          const nc = await connect({
            servers: "ws://localhost:9222",
            token: "ridge_user_bridge_secure_password",
            authenticator: jwtAuthenticator(
              jwt,
              new TextEncoder().encode(seed)
            ),
          });
          statusEl.innerHTML = "üü¢ Connected (Subscribed to cdc.users.>)";
          log("‚úÖ Connected to NATS");

          // 5. Subscribe & Sync
          const sub = nc.subscribe("cdc.users.>");

          (async () => {
            for await (const msg of sub) {
              // Decode
              const decoded = unpack(msg.data);
              // Handle Batch (Array) vs Single Object
              const events = Array.isArray(decoded) ? decoded : [decoded];

              for (const event of events) {
                const { operation, data, table } = event;
                // Only handle 'users' for this demo
                if (table !== "users") continue;

                log(`‚ö° ${operation} on users:${data.id}`);

                if (operation === "INSERT" || operation === "UPDATE") {
                  await db.query(
                    "INSERT INTO users (id, name, email) VALUES ($1, $2, $3) ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, email = EXCLUDED.email",
                    [data.id, data.name, data.email]
                  );
                } else if (operation === "DELETE") {
                  await db.query("DELETE FROM users WHERE id = $1", [data.id]);
                }
              }
              // Update UI
              render(db);
            }
          })();
        } catch (err) {
          console.error(err);
          statusEl.innerHTML = `‚ùå Error: ${err.message}`;
        }
      }

      async function render(db) {
        const res = await db.query("SELECT * FROM users ORDER BY id DESC");
        rowsEl.innerText = JSON.stringify(res.rows, null, 2);
      }

      init();
    </script>
  </body>
</html>
